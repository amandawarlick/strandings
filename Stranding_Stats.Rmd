---
title: 'Pinniped Stranding Analysis Research Questions'
author: Amanda Warlick, March 2017
output:
  word_document: default

---

```{r, include = F}
knitr::opts_chunk$set(echo = T, warning = FALSE, message = FALSE)
```
 

```{r, include = F, echo = F}
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggmap)
library(data.table)
library(cowplot)
library(knitr)
library(reshape2)
library(stringr)
library(magrittr)
library(scales)
library(stats) 
library(PMCMR)
library(pgirmess) #kruskalmc()
library(MASS) #glm.nb()
library(multcomp) #glht()

#setwd("~/Documents/R/Strandings")

# Data Load 
###############################################################################
# Data are pre-cleaned
pinnipeds_data <- read.csv("pinnipeds_data.csv", header = TRUE, na.strings = "", stringsAsFactors = FALSE) %>%
  transform(Decade = ifelse(Year.of.Observation < 2000, '1990s', 
                            ifelse(Year.of.Observation < 2010, '2000s', '2010s'))) %>%
  transform(Period = ifelse(Year.of.Observation < 2005, 'Pre-Prescott', 'Post-Prescott'))

# Set Up Factors
pinnipeds_data$Age.Class <- factor(pinnipeds_data$Age.Class, 
                                   levels = c("Pup", "Yearling", "Subadult", "Adult", "Unid"))

pinnipeds_data$Month.of.Observation <- factor(pinnipeds_data$Month.of.Observation, 
                      levels = c('JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'))

```


##Changes in total annual strandings per year  
 
- Are total annual combined strandings or of each species increasing or decreasing over time?
```{r}
### Are total annual combined strandings or of each species increasing over time?  

#Could use lm() to derive and report slope of line, glm for test statistics/p-values, or glm and reporting fold increase per decade.

## 1. All strandings, combined species
data_by_year <- pinnipeds_data %>% 
  group_by(Year.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number)) 

data_by_decade <- pinnipeds_data %>% 
  group_by(Decade) %>%
  summarize(cnt = n_distinct(National.Database.Number)) 

# GLM with Poisson
summary(glm(cnt ~ Year.of.Observation, family = poisson(link = log), data = data_by_year))
#slope of line =  exp(0.050462*x) = y = 1.05^x = 5%/year

#Negative binomial GLM
summary(glm.nb(cnt ~ Year.of.Observation, data = data_by_year))
#slope of line =  exp(0.046800*x) = y = 1.0479^x = 4.8%/year

#Linear
# summary(lm(cnt ~ Year.of.Observation, data_by_year)) #y = 25x


##1. All strandings, separate species
all_sp <- pinnipeds_data %>%
  group_by(Year.of.Observation, Pinniped.Common.Name) %>%
  summarize(cnt = n_distinct(National.Database.Number))

###Harbor seal
#Linear
# summary(lm(cnt ~ Year.of.Observation, data = all_sp %>% filter(Pinniped.Common.Name == 'Harbor seal'))) #y = 16x

#GLM with Poisson
summary(glm(cnt ~ Year.of.Observation, family = poisson(link = log), data = all_sp %>% filter(Pinniped.Common.Name == 'Harbor seal'))) # y = 1.1^x

#Negative binomial
summary(glm.nb(cnt ~ Year.of.Observation, data = all_sp %>% filter(Pinniped.Common.Name == 'Harbor seal'))) # y = exp(5.575e-02x) = 1.786 fold per decade

###CSL
#Linear
# summary(lm(cnt ~ Year.of.Observation, data = all_sp %>% filter(Pinniped.Common.Name == 'California sea lion'))) # y = 7.9x

#GLM with Poisson
summary(glm(cnt ~ Year.of.Observation, family = poisson(link = log), data = all_sp %>% filter(Pinniped.Common.Name == 'California sea lion'))) # y = 1.1^x

#Negative binomial
summary(glm.nb(cnt ~ Year.of.Observation, data = all_sp %>% filter(Pinniped.Common.Name == 'California sea lion'))) # y = 1.1^x = 2.63 fold per decade

###SSL
# summary(lm(cnt ~ Year.of.Observation, data = all_sp %>% filter(Pinniped.Common.Name == 'Steller sea lion'))) # y = 3.9x

summary(glm(cnt ~ Year.of.Observation, family = poisson(link = log), data = all_sp %>% filter(Pinniped.Common.Name == 'Steller sea lion'))) # y = 1.1^x

summary(glm.nb(cnt ~ Year.of.Observation, data = all_sp %>% filter(Pinniped.Common.Name == 'Steller sea lion'))) # y = exp(0.13372x) = 1.14^x = 14%

#GFS
# summary(lm(cnt ~ Year.of.Observation, data = all_sp %>% filter(Pinniped.Common.Name == 'Guadalupe fur seal'))) # y = 1.4x

summary(glm(cnt ~ Year.of.Observation, family = poisson(link = log), data = all_sp %>% filter(Pinniped.Common.Name == 'Guadalupe fur seal'))) # y = 1.1^x

summary(glm.nb(cnt ~ Year.of.Observation, data = all_sp %>% filter(Pinniped.Common.Name == 'Guadalupe fur seal'))) # y = exp(.15444x) = y = 1.167^x = 1.0 = 100%/decade, p < 0.1

###NES
# summary(lm(cnt ~ Year.of.Observation, data = all_sp %>% filter(Pinniped.Common.Name == 'Northern elephant seal'))) 

summary(glm(cnt ~ Year.of.Observation, family = poisson(link = log), data = all_sp %>% filter(Pinniped.Common.Name == 'Northern elephant seal')))

summary(glm.nb(cnt ~ Year.of.Observation, data = all_sp %>% filter(Pinniped.Common.Name == 'Northern elephant seal'))) #not sig

###NFS
# summary(lm(cnt ~ Year.of.Observation, data = all_sp %>% filter(Pinniped.Common.Name == 'Northern fur seal'))) 

summary(glm(cnt ~ Year.of.Observation, family = poisson(link = log), data = all_sp %>% filter(Pinniped.Common.Name == 'Northern fur seal')))

summary(glm.nb(cnt ~ Year.of.Observation, data = all_sp %>% filter(Pinniped.Common.Name == 'Northern fur seal')))

```

- Are total annual *number* of HI cases increasing over time?
```{r}
# 1. Are total annual human interaction cases increasing/decreasing over time for:

# (a) combined species 
HI_by_year <- pinnipeds_data %>%
  filter(Findings.of.Human.Interaction == 'Y') %>%
  group_by(Year.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number)) 

# <--- Yes, significant increase of all HI cases, 
summary(glm(cnt ~ Year.of.Observation, family = poisson(link = log), data = HI_by_year))
#regression equation: y = exp(0.1089*x) = 1.11^x

summary(glm.nb(cnt ~ Year.of.Observation, data = HI_by_year))
#regression equation: y = exp(0.09643*x) = 1.10^x = 10% per year

# (b) certain HI types
HI_type_by_year <- pinnipeds_data %>%
  filter(Findings.of.Human.Interaction == 'Y' & Interaction.Type != 'NA') %>%
  group_by(Year.of.Observation, Interaction.Type) %>%
  summarize(cnt = n_distinct(National.Database.Number)) 

summary(glm(cnt ~ Year.of.Observation, family = poisson(link = log), data = HI_type_by_year %>% filter(Interaction.Type == 'Gunshot')))
summary(glm.nb(cnt ~ Year.of.Observation, data = HI_type_by_year %>% filter(Interaction.Type == 'Gunshot')))

summary(glm(cnt ~ Year.of.Observation, family = poisson(link = log), data = HI_type_by_year %>% filter(Interaction.Type == 'Fisheries')))
summary(glm.nb(cnt ~ Year.of.Observation, data = HI_type_by_year %>% filter(Interaction.Type == 'Fisheries')))

summary(glm(cnt ~ Year.of.Observation, family = poisson(link = log), data = HI_type_by_year %>% filter(Interaction.Type == 'Boat')))
summary(glm.nb(cnt ~ Year.of.Observation, data = HI_type_by_year %>% filter(Interaction.Type == 'Boat')))

# (c) for individual species?  
HI_sp <- pinnipeds_data %>%
  filter(Findings.of.Human.Interaction == 'Y' & Interaction.Type != 'NA') %>%
  group_by(Year.of.Observation, Pinniped.Common.Name) %>%
  summarize(cnt = n_distinct(National.Database.Number))

summary(glm.nb(cnt ~ Year.of.Observation, data = HI_sp %>% filter(Pinniped.Common.Name == 'Harbor seal'))) # y = 1.11^x

summary(glm.nb(cnt ~ Year.of.Observation, data = HI_sp %>% filter(Pinniped.Common.Name == 'California sea lion'))) # y = 1.1^x

summary(glm.nb(cnt ~ Year.of.Observation, data = HI_sp %>% filter(Pinniped.Common.Name == 'Steller sea lion'))) # y = 1.095^x

summary(glm.nb(cnt ~ Year.of.Observation, data = HI_sp %>% filter(Pinniped.Common.Name == 'Northern elephant seal'))) # not sig

summary(glm.nb(cnt ~ Year.of.Observation, data = HI_sp %>% filter(Pinniped.Common.Name == 'Guadalupe fur seal'))) # y = .159^x

summary(glm.nb(cnt ~ Year.of.Observation, data = HI_sp %>% filter(Pinniped.Common.Name == 'Northern fur seal')))  #insufficient observations?
```

- Is the *prevalence* of human interaction cases increasing or decreasing over time for certain species? 
```{r}

#2. Changing prevalence over time

#All HI cases, species combined
HI_yes_no <- pinnipeds_data %>%
  group_by(Year.of.Observation, Findings.of.Human.Interaction) %>%
  summarize(cnt = n_distinct(National.Database.Number)) %>%
  dcast(Year.of.Observation ~ Findings.of.Human.Interaction, value.var = 'cnt')
HI_yes_no[is.na(HI_yes_no)] <- 0
HI_yes_no <- HI_yes_no %>%
    transform(Yes = Y, No = (N+CBD)) %>%
  dplyr::select(-c(CBD, N, Y)) 

#For Moni: do I needed a link = identity?
summary(glm(cbind(Yes, No) ~ Year.of.Observation, family = binomial, data = HI_yes_no)) 

#Same as above
summary(glm(cbind(Yes, No) ~ Year.of.Observation, family = binomial(link = logit), data = HI_yes_no)) # y = 0.063x = 0.06 per year untransformed #help is this percent increase over time? or cases?

summary(glm(cbind(Yes, No) ~ Year.of.Observation, family = binomial(link = log), 
            data = HI_yes_no)) # y = 1.059^x = 5.9%/year 

#All HI cases, separate species
HI_yes_no_sp <- pinnipeds_data %>%
  filter(Pinniped.Common.Name != 'Unidentified') %>% 
  group_by(Pinniped.Common.Name, Year.of.Observation, Findings.of.Human.Interaction) %>%
  summarize(cnt = n_distinct(National.Database.Number)) %>%
  dcast(Pinniped.Common.Name + Year.of.Observation ~ Findings.of.Human.Interaction, value.var = 'cnt')
HI_yes_no_sp[is.na(HI_yes_no_sp)] <- 0
HI_yes_no_sp <- HI_yes_no_sp %>%
  transform(Yes = Y, No = (N+CBD)) %>%
  dplyr::select(Pinniped.Common.Name, Year.of.Observation, Yes, No) 

#Repeat for each species
summary(glm(cbind(Yes, No) ~ Year.of.Observation, family = binomial, data = HI_yes_no_sp %>% filter(Pinniped.Common.Name == 'Harbor seal'))) #y = 

summary(glm(cbind(Yes, No) ~ Year.of.Observation, family = binomial, data = HI_yes_no_sp %>% filter(Pinniped.Common.Name == 'California sea lion')))

summary(glm(cbind(Yes, No) ~ Year.of.Observation, family = binomial, data = HI_yes_no_sp %>% filter(Pinniped.Common.Name == 'Steller sea lion'))) #not sig

summary(glm(cbind(Yes, No) ~ Year.of.Observation, family = binomial, data = HI_yes_no_sp %>% filter(Pinniped.Common.Name == 'Northern elephant seal')))

summary(glm(cbind(Yes, No) ~ Year.of.Observation, family = binomial, data = HI_yes_no_sp %>% filter(Pinniped.Common.Name == 'Guadalupe fur seal'))) #not sig

summary(glm(cbind(Yes, No) ~ Year.of.Observation, family = binomial, data = HI_yes_no_sp %>% filter(Pinniped.Common.Name == 'Northern fur seal'))) #not sig

#Separate HI types, combined species
numberperyear <- pinnipeds_data %>% 
  group_by(Year.of.Observation) %>%
  summarize(yr.cnt = n_distinct(National.Database.Number))

HI_type_yes_no <- pinnipeds_data %>%
  filter(Findings.of.Human.Interaction == 'Y' & Interaction.Type != 'NA') %>%
  group_by(Interaction.Type, Year.of.Observation) %>%
  summarize(Yes = n_distinct(National.Database.Number)) %>%
  dcast(Year.of.Observation ~ Interaction.Type, value.var = 'Yes') 
HI_type_yes_no[is.na(HI_type_yes_no)] <- 0
HI_type_yes_no <- HI_type_yes_no %>%
  merge(numberperyear, by = c('Year.of.Observation')) %>%
  transform(NoBoat = yr.cnt - Boat, 
            NoFish = yr.cnt - Fisheries,
            NoGun = yr.cnt - Gunshot,
            NoOther = yr.cnt - Other) %>%
  dplyr::select(-c(yr.cnt)) 

# <-- Proportion of each interaction type changing over time, boat and other increasing at a faster rate than fisheries and gunshot wounds?
summary(glm(cbind(Boat, NoBoat) ~ Year.of.Observation, family = binomial, data = HI_type_yes_no)) # y = 0.08687x
summary(glm(cbind(Fisheries, NoFish) ~ Year.of.Observation, family = binomial, data = HI_type_yes_no)) # y = 0.043703x
summary(glm(cbind(Gunshot, NoGun) ~ Year.of.Observation, family = binomial, data = HI_type_yes_no)) # y = exp(0.039296*x) = 1.04^x
summary(glm(cbind(Other, NoOther) ~ Year.of.Observation, family = binomial, data = HI_type_yes_no)) # y = exp(0.08310*x) = 1.086^x

#Separate HI types, separate species
numberperyearperspecies <- pinnipeds_data %>% 
  group_by(Year.of.Observation, Pinniped.Common.Name) %>%
  summarize(yr.cnt = n_distinct(National.Database.Number))

HIcount_type_species <- pinnipeds_data %>%
  filter(Findings.of.Human.Interaction == 'Y' & 
           Pinniped.Common.Name != "Unidentified" &
           Interaction.Type != 'NA') %>%
  group_by(Interaction.Type, Year.of.Observation, Pinniped.Common.Name) %>%
  summarize(cnt = n_distinct(National.Database.Number)) %>%
  dcast(Year.of.Observation + Pinniped.Common.Name ~ Interaction.Type, value.var = 'cnt')
HIcount_type_species[is.na(HIcount_type_species)] <- 0
HIcount_type_species <- HIcount_type_species %>%
  merge(numberperyearperspecies, by = c('Year.of.Observation', 'Pinniped.Common.Name')) %>%
  transform(NoBoat = yr.cnt - Boat, 
            NoFish = yr.cnt - Fisheries,
            NoGun = yr.cnt - Gunshot,
            NoOther = yr.cnt - Other) %>%
  dplyr::select(-c(yr.cnt))  

#Which types of cases might be increasing or decreasing for which species?
#Not sig or insuff data for CSL, SSL, NFS, NES, GFS
summary(glm(cbind(Boat, NoBoat) ~ Year.of.Observation, family = binomial, data = HIcount_type_species %>% filter(Pinniped.Common.Name == 'Guadalupe fur seal')))

#not sig for SSL, NFS, NES, GFS
summary(glm(cbind(Fisheries, NoFish) ~ Year.of.Observation, family = binomial, data = HIcount_type_species %>% filter(Pinniped.Common.Name == 'Guadalupe fur seal')))

#not sig for harbors, SSL, NFS, NES, GFS
summary(glm(cbind(Gunshot, NoGun) ~ Year.of.Observation, family = binomial, data = HIcount_type_species %>% filter(Pinniped.Common.Name == 'Guadalupe fur seal')))

# summary(glm(cbind(Other, NoOther) ~ Year.of.Observation, family = binomial, data = HIcount_type_species %>% filter(Pinniped.Common.Name == 'Harbor seal')))

#Proportion of types per species - old, changed to yes/no counts
# HIprev_type_species <- pinnipeds_data %>%
#   filter(Findings.of.Human.Interaction == 'Y' & Pinniped.Common.Name != "Unidentified") %>%
#   group_by(Interaction.Type, Year.of.Observation, Pinniped.Common.Name) %>%
#   summarize(cnt = n_distinct(National.Database.Number)) %>%
#   dcast(Year.of.Observation + Pinniped.Common.Name ~ Interaction.Type, value.var = 'cnt') 
# HIprev_type_species[is.na(HIprev_type_species)] <- 0
# HIprev_type_species <- HIprev_type_species %>%
#   merge(numberperyearperspecies, by = c('Year.of.Observation', 'Pinniped.Common.Name')) %>%
#   transform(Boat = (Boat/yr.cnt), 
#             Fisheries = (Fisheries/yr.cnt),
#             Gunshot = (Gunshot/yr.cnt),
#             Other = (Other/yr.cnt)) %>%
#   dplyr::select(Year.of.Observation, Pinniped.Common.Name, Boat, Gunshot, Fisheries, Other) %>%
#   melt(id.vars = c("Year.of.Observation", "Pinniped.Common.Name")) 

# summary(lm(value ~ Year.of.Observation, data = HIprev_type_species %>% filter(Pinniped.Common.Name == 'California sea lion' & variable == 'Boat')))
# summary(lm(value ~ Year.of.Observation, data = HIprev_type_species %>% filter(Pinniped.Common.Name == 'California sea lion' & variable == 'Fisheries'))) 
# summary(lm(value ~ Year.of.Observation, data = HIprev_type_species %>% filter(Pinniped.Common.Name == 'California sea lion' & variable == 'Gunshot'))) 

```

## Seasonality  

- Is there a seasonal peak in strandings and HI cases for certain species? 
```{r}

#3. Seasonal peak for overall counts?
 
monthly_all <- pinnipeds_data %>%
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  group_by(Month.of.Observation, Year.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number))

# <-- Yes, May through October is different from the rest of the year
kruskal.test(monthly_all)
kruskalmc(monthly_all$cnt ~ monthly_all$Month.of.Observation)
posthoc.kruskal.nemenyi.test(cnt ~ Month.of.Observation, data = monthly_all, dist = "Chisquare")
  
#4. Is there a seasonal peak in stranding cases for certain species? 
monthly_species <- pinnipeds_data %>%
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Pinniped.Common.Name != 'Unidentified') %>%
  group_by(Month.of.Observation, Pinniped.Common.Name, Year.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number))

#glm with and without interaction, anova the two
monthly_all_model_sp <- glm(cnt ~ Pinniped.Common.Name + Month.of.Observation, family = poisson(link = log), data = monthly_species)

monthly_all_model_sp_int <- glm(cnt ~ Pinniped.Common.Name * Month.of.Observation, family = poisson(link = log), data = monthly_species)

anova(monthly_all_model_sp, monthly_all_model_sp_int, test = 'Chisq')

#Alternative parametetric pairwise method using glht
monthly_all_glht <- glm.nb(cnt ~ Month.of.Observation, data = monthly_all)
summary(glht(monthly_all_glht, linfct = mcp(Month.of.Observation = "Tukey")))

```

- Is there a seasonal peak for certain species?
```{r}

#For Moni - is it correct to use glm to see the specific peak for each species?
# <--- months with significant p-values indicate months that are significantly different from the reference month (January?), either higher or lower?
summary(glm(cnt ~ Month.of.Observation, family = poisson(link = log), data = monthly_species %>% filter(Pinniped.Common.Name == 'Harbor seal'))) #Apr - Oct
summary(glm(cnt ~ Month.of.Observation, family = poisson(link = log), data = monthly_species %>% filter(Pinniped.Common.Name == 'Northern fur seal'))) #Nov
summary(glm(cnt ~ Month.of.Observation, family = poisson(link = log), data = monthly_species %>% filter(Pinniped.Common.Name == 'Guadalupe fur seal'))) #June
summary(glm(cnt ~ Month.of.Observation, family = poisson(link = log), data = monthly_species %>% filter(Pinniped.Common.Name == 'Northern elephant seal'))) #June
summary(glm(cnt ~ Month.of.Observation, family = poisson(link = log), data = monthly_species %>% filter(Pinniped.Common.Name == 'California sea lion'))) #May, Aug-Nov
summary(glm(cnt ~ Month.of.Observation, family = poisson(link = log), data = monthly_species %>% filter(Pinniped.Common.Name == 'Steller sea lion'))) #Mar

# Same as above but for HI cases  
monthly_species_HI <- pinnipeds_data %>%
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Pinniped.Common.Name != 'Unidentified') %>%
  filter(Findings.of.Human.Interaction == 'Y') %>%
  group_by(Month.of.Observation, Pinniped.Common.Name, Year.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number)) 

#Combined species
monthly_HI_model_sp <- glm(cnt ~ Pinniped.Common.Name + Month.of.Observation, family = poisson(link = log), data = monthly_species_HI)

monthly_HI_model_sp_int <- glm(cnt ~ Pinniped.Common.Name * Month.of.Observation, family = poisson(link = log), data = monthly_species_HI)

anova(monthly_HI_model_sp, monthly_HI_model_sp_int, test = 'Chisq')

#Separate species, same as above for all strandings 
# <--- insufficient observations to look at all species
summary(glm(cnt ~ Month.of.Observation, family = poisson(link = log), data = monthly_species_HI %>% filter(Pinniped.Common.Name == 'Harbor seal'))) #Jun - Oct
summary(glm(cnt ~ Month.of.Observation, family = poisson(link = log), data = monthly_species_HI %>% filter(Pinniped.Common.Name == 'Northern fur seal'))) #Not sig
summary(glm(cnt ~ Month.of.Observation, family = poisson(link = log), data = monthly_species_HI %>% filter(Pinniped.Common.Name == 'Guadalupe fur seal'))) #Not sig
summary(glm(cnt ~ Month.of.Observation, family = poisson(link = log), data = monthly_species_HI %>% filter(Pinniped.Common.Name == 'Northern elephant seal'))) #Not sig
summary(glm(cnt ~ Month.of.Observation, family = poisson(link = log), data = monthly_species_HI %>% filter(Pinniped.Common.Name == 'California sea lion'))) #Not sig
summary(glm(cnt ~ Month.of.Observation, family = poisson(link = log), data = monthly_species_HI %>% filter(Pinniped.Common.Name == 'Steller sea lion'))) #March
```


## Spatial Patterns  

- Is there a statistical difference in strandings and HI across counties? (Washington)
```{r}
#6. Is there a statistical difference in strandings/HI across counties? 
# Moni suggests anova(model, model_interaction), but same as above - can I use post hoc nemenyi

#All counties all strandings
bycounty <- pinnipeds_data %>% 
  filter(County != 'NA' & County != 'Unknown') %>%
  transform(County = factor(County)) %>%
  group_by(County, Year.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number))

kruskal.test(bycounty)

#All strandings, WA
allWA_bycounty <- pinnipeds_data %>% 
  filter(County != 'NA' & County != 'Unknown' & State == 'WA') %>%
  transform(County = factor(County)) %>%
  group_by(County, Year.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number))

# <--- Overall, yes, county is a significant predictor. 
kruskal.test(allWA_bycounty)

# <--- Pairwise shows San Juan dif from Mason, Pacific, Clark, Cowlitz, Thurston
#kruskalmc(allWA_bycounty$cnt ~ allWA_bycounty$County) 
posthoc.kruskal.nemenyi.test(cnt ~ County, allWA_bycounty, dist = "Chisquare")

#HI strandings, WA
WAHI_bycounty <- pinnipeds_data %>% 
  filter(County != 'NA' & State == 'WA' & 
           Findings.of.Human.Interaction == 'Y' & 
           Interaction.Type != 'NA') %>% 
  transform(County = factor(County)) %>%
  group_by(County, Year.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number))

# <--- County is a significant predictor overall. 
kruskal.test(WAHI_bycounty)

# <--- Pairwise shows higher in Pacific
kruskalmc(WAHI_bycounty$cnt ~ WAHI_bycounty$County)
posthoc.kruskal.nemenyi.test(cnt ~ County, WAHI_bycounty, dist = "Chisquare")


```

- Is there a statistical difference in strandings and HI across counties? (Oregon)
```{r}

#All strandings, OR
allOR_bycounty <- pinnipeds_data %>% 
  filter(County != 'NA' & County != 'Unknown' & State == 'OR') %>% 
  transform(County = factor(County)) %>%
  group_by(County, Year.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number))

# <--- K-W show strandings higher in Lincoln
kruskal.test(allOR_bycounty)
posthoc.kruskal.nemenyi.test(cnt ~ County, allOR_bycounty, dist = "Chisquare")

#HI strandings, OR
ORHI_bycounty <- pinnipeds_data %>% 
  filter(County != 'NA' & State == 'OR' & 
           Findings.of.Human.Interaction == 'Y' & 
           Interaction.Type != 'NA') %>% 
  transform(County = factor(County)) %>%
  group_by(County, Year.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number)) 

# <--- K-W shows Clatsop, Lincoln
kruskal.test(ORHI_bycounty)
posthoc.kruskal.nemenyi.test(cnt ~ County, ORHI_bycounty, dist = "Tukey")


```

Is the prevalence of HI cases higher than expected given the distribution of overall strandings?
```{r}

#7. Is the prevalence of HI cases higher than expected given the distribution of overall strandings?

# Yes, No for HI by county
HI_yes_no_county <- pinnipeds_data %>%
  filter(County != 'Unknown') %>%
  group_by(County, Findings.of.Human.Interaction) %>%
  summarize(cnt = n_distinct(National.Database.Number)) %>%
  dcast(County ~ Findings.of.Human.Interaction, value.var = 'cnt')
HI_yes_no_county[is.na(HI_yes_no_county)] <- 0
HI_yes_no_county <- HI_yes_no_county %>%
  transform(Yes = Y, No = (N+CBD)) %>%
  dplyr::select(County, Yes, No) 

# For Moni - struggling to implement the right test, and how to interpret the output. The counties coming up with significant p-values are compared to a reference county, right? I want the HI cases compared to the non-HI cases
summary(glm(cbind(Yes, No) ~ County, family = binomial, data = HI_yes_no_county))

```

Extra Questions
- Are specific types of HI cases increasing or decreasing in certain counties?
```{r}

HI_yes_no_county_yr <- pinnipeds_data %>%
  group_by(County, Year.of.Observation, Findings.of.Human.Interaction) %>%
  summarize(cnt = n_distinct(National.Database.Number)) %>%
  dcast(County + Year.of.Observation ~ Findings.of.Human.Interaction, value.var = 'cnt')
HI_yes_no_county_yr[is.na(HI_yes_no_county_yr)] <- 0
HI_yes_no_county_yr <- HI_yes_no_county_yr %>%
  transform(Yes = Y, No = (N+CBD)) %>%
  dplyr::select(County, Year.of.Observation, Yes, No) 

# Are gunshot, entanglements, or boat collisions increasing in certain counties? 

#Washington
WAHI_type_yr <- pinnipeds_data %>% 
  filter(County != 'NA' & State == 'WA' & 
           Findings.of.Human.Interaction == 'Y' & 
           Interaction.Type != 'NA') %>% 
  transform(County = factor(County)) %>%
  group_by(County, Year.of.Observation, Interaction.Type) %>%
  summarize(cnt = n_distinct(National.Database.Number))

# <--- Shows increasing in Grays, Pacific, Pierce, CLallam, Whatcom?
WAHI_yr_model <- glm(cnt ~ County + Year.of.Observation, family = poisson(link = log), WAHI_type_yr)
summary(WAHI_yr_model)
# (Intercept)         -6.830e+01  1.018e+01  -6.707 1.98e-11 ***
# CountyGrays Harbor   7.045e-01  1.669e-01   4.221 2.43e-05 *** y = 2.02x
# CountyPacific        7.491e-01  1.594e-01   4.699 2.61e-06 *** y = 2.1x
# CountyPierce         8.177e-01  1.552e-01   5.270 1.36e-07 *** y = 2.3x
# Year.of.Observation  3.431e-02  5.071e-03   6.766 1.32e-11 *** y = 1.0x

# <--- Shows only "other" increasing in Pierce?
WAHI_type_yr_model <- glm(cnt ~ County*Interaction.Type, family = poisson(link = log), WAHI_type_yr)
summary(WAHI_type_yr_model)

# Oregon
ORHI_type_bycounty <- pinnipeds_data %>% 
  filter(County != 'NA' & State == 'OR' & 
           Findings.of.Human.Interaction == 'Y' & 
           Interaction.Type != 'NA') %>% 
  transform(County = factor(County)) %>%
  group_by(County, Interaction.Type, Year.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number)) 

#Increasing just in Clallam and Clatsop, not changing either way anywhere else
ORcounty_HI_model <- glm(cnt ~ County + Year.of.Observation, family = poisson(link = log), ORHI_type_bycounty)
summary(ORcounty_HI_model)

# CountyClatsop         1.420888   0.582208   2.441   0.0147 *    y = 4.1x
# Year.of.Observation   0.041630   0.007356   5.660 1.52e-08 ***  y = 1.0x

# <--- Shows none are significant
ORHI_type_yr_model <- glm(cnt ~ County*Interaction.Type, family = poisson(link = log), ORHI_type_bycounty)
summary(ORHI_type_yr_model)

```


## Categorical/Basic Species, Age and Sex Classes  

- Is there a difference in species of strandings and HI cases? 

```{r}
#all strandings
species <- pinnipeds_data %>%
  group_by(Pinniped.Common.Name) %>%
  summarize(cnt = n_distinct(National.Database.Number))

# <--- Yes, species are different
kruskal.test(species)

#HI cases
species_HI <- pinnipeds_data %>%
  filter(Findings.of.Human.Interaction == 'Y') %>%
  group_by(Pinniped.Common.Name) %>%
  summarize(cnt = n_distinct(National.Database.Number))

# <--- Yes, species are different
kruskal.test(species_HI)
kruskalmc(species_HI$cnt ~ species_HI$Pinniped.Common.Name)

```

- Is there a difference in sex of strandings and HI cases?
```{r}

# Is there a difference in sex of strandings/HI cases?  
 
#All strandings
Sex_all_yr <- pinnipeds_data %>%
  filter(Sex == 'Male' | Sex == 'Female') %>%
  group_by(Sex, Year.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number)) 

# <--- Yes, males different (higher) from females
kruskal.test(Sex_all_yr)
kruskalmc(Sex_all_yr$cnt ~ Sex_all_yr$Sex)

#HI strandings
Sex_HI_yr <- pinnipeds_data %>%
  filter(Sex == 'Male' | Sex == 'Female') %>%
  filter(Findings.of.Human.Interaction == 'Y' & Interaction.Type != 'NA') %>%
  group_by(Sex, Year.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number)) 

# <-- Yes, males different (higher) from females
kruskal.test(Sex_HI_yr)
kruskalmc(Sex_HI_yr$cnt ~ Sex_HI_yr$Sex)
# sex_HI_model <- glm.nb(cnt ~ Sex, Sex_HI_yr)
# summary(sex_HI_model)

```

- Is there a difference in sex of strandings across months of the year?
```{r}
# Is there a difference in sex of strandings in different seasons?

#All strandings
Sex_all_mo <- pinnipeds_data %>%
  filter(Sex == 'Male' | Sex == 'Female') %>%
  group_by(Sex, Month.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number)) 

Sex_all_mo_male <- pinnipeds_data %>%
  filter(Sex == 'Male') %>%
  group_by(Year.of.Observation, Month.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number)) 

Sex_all_mo_fem <- pinnipeds_data %>%
  filter(Sex == 'Female') %>%
  group_by(Year.of.Observation, Month.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number)) 

# <--- For females, July is different from Jan through May, whereas for males, July is different from only Jan, Feb (males stranding more in late spring, so broader peak?)
kruskal.test(Sex_all_mo_fem)
posthoc.kruskal.nemenyi.test(cnt ~ Month.of.Observation, Sex_all_mo_fem, dist = "Chisquare")

kruskal.test(Sex_all_mo_male)
posthoc.kruskal.nemenyi.test(cnt ~ Month.of.Observation, Sex_all_mo_male, dist = "Chisquare")


```

- Is there a difference in age class of strandings and HI cases?
```{r}
# Is there a difference in age class strandings/HI cases? 

#all strandings
age_all <- pinnipeds_data %>%
  group_by(Age.Class, Year.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number)) 

# <--- Yes, pups and adults (not different from each other) are different from subadults and yearlings (not different from each other). p < 0.05, difs amount to ~38 animals/yr
kruskal.test(age_all)
kruskalmc(age_all$cnt ~ age_all$Age.Class)
#posthoc.kruskal.nemenyi.test(cnt ~ Age.Class, age_all, dist = "Chisquare")

#HI strandings
age_HI <- pinnipeds_data %>%
  filter(Findings.of.Human.Interaction == 'Y') %>%
  group_by(Age.Class, Year.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number)) 

# <--- Yes, yearlings significantly different (lower). p < 0.05, difs amount to ~38 animals/yr
kruskal.test(age_HI)
kruskalmc(age_HI$cnt ~ age_HI$Age.Class)
#posthoc.kruskal.nemenyi.test(cnt ~ Age.Class, age_HI, dist = "Chisquare")

```

- Is there a difference in age of strandings across months of the year?
```{r}
# Is there a difference in age of strandings in different seasons?

#All strandings
age_all_mo <- pinnipeds_data %>%
  group_by(Age.Class, Month.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number)) 

 
kruskal.test(age_all_mo)
posthoc.kruskal.nemenyi.test(cnt ~ Month.of.Observation, age_all_mo, dist = "Chisquare")


age_all_mo_model <- glm(cnt ~ Age.Class + Month.of.Observation, data = age_all_mo)

age_all_mo_model_int <- glm(cnt ~ Age.Class * Month.of.Observation, data = age_all_mo)
summary(age_all_mo_model_int)

anova(age_all_mo_model, age_all_mo_model_int, test = 'Chisq')

```

- Is there a difference between ages and sexes?
- Help: would like non-parametric test for multiple categorical variables? 
```{r }
#Differences between ages and sexes?  
age_sex_all <- pinnipeds_data %>%
  group_by(Sex, Age.Class, Year.of.Observation) %>%
  summarize(cnt = n_distinct(National.Database.Number))

#Need non-parametric version of this, for multiple comparisons :(  help
TukeyHSD(aov(cnt ~ Sex*Age.Class, data = age_sex_all))

# kruskalmc(age_sex_all$cnt ~ age_sex_all$Age.Class*age_sex_all$Sex)
# posthoc.kruskal.nemenyi.test(cnt ~ Age.Class + Sex, age_sex_all, dist = "Chisquare")

```



