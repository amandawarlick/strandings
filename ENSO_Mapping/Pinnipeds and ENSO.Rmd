
---
title: "Pinniped ENSO Strandings"
output: 
  word_document: 
    reference_docx: markdownstyledoc.docx
---

```{r include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 4, fig.height = 3.5)
```

```{r load packages, echo = FALSE}

# install.packages("ggmap") 
# install.packages("data.table")
#install.packages("devtools")
library(devtools)
#devtools::install_github("hadley/ggplot2")
#devtools::install_github("adletaw/captioner")
library(tidyr)
library(ggmap)
library(data.table)
library(dplyr)
library(ggplot2)
library(cowplot)
library(stats)
library(scales)
library(captioner)
library(knitr)
library(reshape2)
library(stringr)
library(magrittr)
library(stats) #kruskal.test
library(PMCMR) # posthoc.kruskal.nemenyi.test https://cran.r-project.org/web/packages/PMCMR/vignettes/PMCMR.pdf
library(strucchange) # chow test https://cran.r-project.org/web/packages/strucchange/strucchange.pdf  
library(pgirmess) 

setwd("~/Documents/R/Strandings/ENSO_Mapping")

plot_theme <- function(...) {
  theme(
    #text = element_text(size = 11),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, color = "black", size = 10), 
    axis.text = element_text(vjust = 0.5, color = "black", size = 10), 
    axis.title = element_text(size = 11),
    axis.line.y = element_line(colour = "black"), 
    axis.line.x = element_line(colour = "black"), 
    plot.background = element_rect(), 
    panel.background = element_blank(), 
    panel.grid = element_blank(), 
    legend.title = element_blank(),
    legend.key = element_blank(),
    legend.text = element_text(size = 8),
    ...)
}

case <- function(x)
  paste0(toupper(substr(x, 1, 1)), tolower(substring(x, 2)))

figs <- captioner(prefix="Figure")
tbls <- captioner(prefix="Table")

# figs("name")
# ## [1] "Figure  1: Caption."
# 
# figs("name",display="cite")
# ## [1] "Figure  1"
# 
# figs("name",display="num")
# ## [1] "1"

color1 <- c("#e45f56", "#a3d39c", "#4aaaa5", "#363e7e", "#f6b61c", "#3b98ee", "#999aa7")


```

```{r load pre-built data, echo = FALSE}

pinnipeds_data <- read.csv("pinnipeds_data.csv", header = TRUE, na.strings = "NA", stringsAsFactors = FALSE) 

pinnipeds_data$Month.of.Observation <- factor(pinnipeds_data$Month.of.Observation, levels = c('JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'))



ocean <- read.csv("ocean.csv", header = TRUE, na.strings = "NA", stringsAsFactors = FALSE) %>%
  transform(Date = as.Date(Date, format = "%Y-%m-%d"),
            Date_lag1 = as.Date(Date, format = "%Y-%m-%d"),
            Date_lag2 = as.Date(Date, format = "%Y-%m-%d"),
            Date_lag3 = as.Date(Date, format = "%Y-%m-%d"))
ocean

fish <- read.csv("fish.csv", header = TRUE, na.strings = "NA", stringsAsFactors = FALSE) %>%
  transform(Date = as.Date(Date, format = "%Y-%m-%d"))

#Full data set
pinnipeds_ocean <- pinnipeds_data %>%
  filter(Pinniped.Common.Name == 'Harbor seal' | Pinniped.Common.Name == 'California sea lion' |
           Pinniped.Common.Name == 'Steller sea lion') %>%
  filter(National.Database.Number != 'NA' | !is.na(National.Database.Number)) %>%
  select(-c(Affiliation, Locality.Detail, Field.Number, Mammal.Type, Day.of.Observation, City...from.strandings.table, Common.Name, Genus, Species, Country, Restrand, Entangled.Flag, Gear.Collection.Flag, Gear.Disposition.Flag, Other.Findings.upon.Level.Y.N, Other.Findings...Illness.Flag, Other.Findings...Injury.Flag, Other.Findings...Pregnant.Flag, How.Observed)) %>%
  merge(ocean, by = c('Year.of.Observation', 'Month.of.Observation'), all = T) %>%
  merge(fish, by = c('Year.of.Observation', 'Month.of.Observation'), all = T) %>%
  transform(Season = 
        ifelse(Month.of.Observation == 'DEC' | Month.of.Observation == 'JAN' | Month.of.Observation == 'FEB', 'Winter', 
        ifelse(Month.of.Observation == 'MAR' | Month.of.Observation == 'APR' | Month.of.Observation == 'MAY', 'Spring', 
        ifelse(Month.of.Observation == 'JUN' | Month.of.Observation == 'JUL' | Month.of.Observation == 'AUG', 'Summer', 'Fall'))))
  
pinnipeds_ocean$Month.of.Observation <- factor(pinnipeds_ocean$Month.of.Observation, levels = c('JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'))

#setwd("~/Documents/R/Strandings/ENSO_Mapping")

```

```{r}
##Annual anomalies

#Annual mean strandings
annual_mean <- pinnipeds_ocean %>%
  #filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Water.Body != 'Inland_WA') %>%
  group_by(Year.of.Observation, Pinniped.Common.Name) %>%
  summarize(cnt = n_distinct(National.Database.Number)) %>%
  group_by(Pinniped.Common.Name) %>%
  summarize(mean_strand = mean(cnt))

#Anomalies dataframe 
annual_anom_strands <- pinnipeds_ocean %>%
  #filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Water.Body != 'Inland_WA') %>%
  filter(Pinniped.Common.Name != 'NA' | !is.na(Pinniped.Common.Name)) %>%
  group_by(Year.of.Observation, Pinniped.Common.Name) %>%
  summarize(cnt = n_distinct(National.Database.Number)) %>%
  merge(annual_mean, by = 'Pinniped.Common.Name') %>%
  transform(strand_anom = cnt - mean_strand)

anom_strand_plot <- ggplot(annual_anom_strands, aes(Year.of.Observation, strand_anom, fill = Pinniped.Common.Name)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  xlab("") + ylab("Stranding Anomalies") +
  plot_theme(legend.position = 'top')

#Annual mean ocean anomalies
annual_mean_ocean <- ocean %>%
  select(-matches("_cat")) %>%
  select(-matches("_lag")) %>%
  select(-c(Date, Month.of.Observation)) %>%
  melt(id.vars = 'Year.of.Observation') %>%
  group_by(Year.of.Observation, variable) %>%
  summarize(mean = mean(value, na.rm = T)) %>%
  dcast(Year.of.Observation ~ variable, value.var = 'mean')

#Anomalies - separate species, annual, melt 
annual_anom <- annual_anom_strands %>%
  select(-mean_strand) %>%
  merge(annual_mean_ocean, by = 'Year.of.Observation') %>%
  melt(id.vars = c('Year.of.Observation', 'Pinniped.Common.Name'))

annual_anom_plot <- ggplot(annual_anom %>% filter(variable != 'cnt'), aes(Year.of.Observation, value, col = variable)) +
  geom_line() +
  xlab("") + ylab("Mean Annual Anomalies") +
  facet_grid(~Pinniped.Common.Name) +
  plot_theme(legend.position = 'top')

#Anomalies - combined species, annual
annual_anom_comb <- annual_anom %>%
  group_by(Year.of.Observation, variable) %>%
  summarize(value = mean(value))

annual_anom_comb_plot <- ggplot(annual_anom_comb %>% filter(variable != 'cnt'), aes(Year.of.Observation, value, col = variable)) +
  geom_line() +
  xlab("") + ylab("Mean Annual Anomalies") +
  plot_theme(legend.position = 'top')

```

```{r}
##Monthly anomalies - all species combined 

#Monthly mean - HI
monthly_mean_HI_comb <- pinnipeds_ocean %>%
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Findings.of.Human.Interaction == 'Y' & Interaction.Type != 'NA') %>%
  filter(Water.Body != 'Inland_WA') %>%
  group_by(Month.of.Observation, Year.of.Observation) %>%
  summarize(cnt_HI = n_distinct(National.Database.Number)) %>%
  group_by(Month.of.Observation) %>%
  summarize(mean_HI = mean(cnt_HI))

#HI Anomalies
monthly_anom_HI_comb <- pinnipeds_ocean %>%
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Findings.of.Human.Interaction == 'Y' & Interaction.Type != 'NA') %>%
  filter(Water.Body != 'Inland_WA') %>%
  group_by(Month.of.Observation, Year.of.Observation) %>%
  summarize(cnt_HI = n_distinct(National.Database.Number)) %>%
  merge(monthly_mean_HI_comb, by = c('Month.of.Observation'), all = T) %>%
  transform(strand_anom_HI = cnt_HI - mean_HI)

#Monthly mean - FI + Gun
monthly_mean_FI_comb <- pinnipeds_ocean %>%
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Interaction.Type == 'Gunshot' | Interaction.Type == 'Fisheries') %>%
  filter(Water.Body != 'Inland_WA') %>%
  group_by(Month.of.Observation, Year.of.Observation) %>%
  summarize(cnt_FI = n_distinct(National.Database.Number)) %>%
  group_by(Month.of.Observation) %>%
  summarize(mean_FI = mean(cnt_FI))

#HI Anomalies - FI + Gun
monthly_anom_FI_comb <- pinnipeds_ocean %>%
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Interaction.Type == 'Gunshot' | Interaction.Type == 'Fisheries') %>%
  filter(Water.Body != 'Inland_WA') %>%
  group_by(Month.of.Observation, Year.of.Observation) %>%
  summarize(cnt_FI = n_distinct(National.Database.Number)) %>%
  merge(monthly_mean_FI_comb, by = c('Month.of.Observation'), all = T) %>%
  transform(strand_anom_FI = cnt_FI - mean_FI)

#Monthly mean - all
monthly_mean_all_comb <- pinnipeds_ocean %>%
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Water.Body != 'Inland_WA') %>%
  group_by(Month.of.Observation, Year.of.Observation) %>%
  summarize(cnt_all = n_distinct(National.Database.Number)) %>%
  group_by(Month.of.Observation) %>%
  summarize(mean_all = mean(cnt_all))

#Anomalies dataframe - combined species
monthly_anom_comb <- pinnipeds_ocean %>%
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Water.Body != 'Inland_WA') %>%
  group_by(Year.of.Observation, Month.of.Observation) %>%
  summarize(cnt_all = n_distinct(National.Database.Number)) %>%
  merge(monthly_mean_all_comb, by = c('Month.of.Observation'), all = T) %>%
  transform(strand_anom_all = cnt_all - mean_all) %>%
  merge(monthly_anom_HI_comb, by = c('Month.of.Observation', 'Year.of.Observation'), all = T) %>%
  merge(monthly_anom_FI_comb, by = c('Month.of.Observation', 'Year.of.Observation'), all = T) %>%
  merge(ocean, by = c('Year.of.Observation', 'Month.of.Observation'))

#Anomaies melt - combined species
monthly_anom_comb_melt <- monthly_anom_comb %>%
  select(-matches("lag")) %>%
  select(-matches("cat")) %>%
  melt(id.vars = c('Date', 'Year.of.Observation', 'Month.of.Observation'))

#Anomalies plot, combined species, strandings only
strand_comb_plot <- ggplot(monthly_anom_comb, aes(Date, strand_anom_all)) + 
  geom_line() +
  geom_line(aes(Date, strand_anom_HI), col = 'red') + 
  geom_line(aes(Date, strand_anom_FI), col = 'blue') + 
  geom_line(aes(y = 0), col = 'grey60') + 
  xlab("") + ylab("Monthly Stranding Anomalies") +
  plot_theme()

anom_comb_plot_data <- monthly_anom_comb_melt %>%
  filter(variable == 'strand_anom_all' | variable == 'strand_anom_HI' |
        variable == 'MEI' | variable == 'PDO' | variable == 'NPGO')

anom_comb_plot <- ggplot(anom_comb_plot_data, aes(Date, value, group = variable, col = variable)) +
  geom_line() +
  #geom_line(aes(y = 0), col = 'grey60') + 
  xlab("") + ylab("Monthly Anomalies") +
  #facet_grid(~variable) +
  plot_theme(legend.position = 'top') +
  scale_color_manual(values = color1)

```

```{r }

##Monthly anomalies - by species

#Monthly mean - HI
monthly_mean_HI <- pinnipeds_ocean %>%
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Findings.of.Human.Interaction == 'Y' & Interaction.Type != 'NA') %>%
  group_by(Month.of.Observation, Year.of.Observation, Pinniped.Common.Name) %>%
  summarize(cnt_HI = n_distinct(National.Database.Number)) %>%
  group_by(Pinniped.Common.Name, Month.of.Observation) %>%
  summarize(mean_HI = mean(cnt_HI))

#HI Anomalies
monthly_anom_HI <- pinnipeds_ocean %>%
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Findings.of.Human.Interaction == 'Y' & Interaction.Type != 'NA') %>%
  group_by(Month.of.Observation, Year.of.Observation, Pinniped.Common.Name) %>%
  summarize(cnt_HI = n_distinct(National.Database.Number)) %>%
  merge(monthly_mean_HI, by = c('Pinniped.Common.Name', 'Month.of.Observation'), all = T) %>%
  transform(strand_anom_HI = cnt_HI - mean_HI)

#Monthly mean - FI + Gun
monthly_mean_FI <- pinnipeds_ocean %>%
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Interaction.Type == 'Gunshot' | Interaction.Type == 'Fisheries') %>%
  group_by(Month.of.Observation, Year.of.Observation, Pinniped.Common.Name) %>%
  summarize(cnt_FI = n_distinct(National.Database.Number)) %>%
  group_by(Pinniped.Common.Name, Month.of.Observation) %>%
  summarize(mean_FI = mean(cnt_FI))

#HI Anomalies - FI + Gun
monthly_anom_FI <- pinnipeds_ocean %>%
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Interaction.Type == 'Gunshot' | Interaction.Type == 'Fisheries') %>%
  group_by(Month.of.Observation, Year.of.Observation, Pinniped.Common.Name) %>%
  summarize(cnt_FI = n_distinct(National.Database.Number)) %>%
  merge(monthly_mean_FI, by = c('Pinniped.Common.Name', 'Month.of.Observation'), all = T) %>%
  transform(strand_anom_FI = cnt_FI - mean_FI)

#Monthly mean - all
monthly_mean_all <- pinnipeds_ocean %>%
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  group_by(Month.of.Observation, Year.of.Observation, Pinniped.Common.Name) %>%
  summarize(cnt_all = n_distinct(National.Database.Number)) %>%
  group_by(Pinniped.Common.Name, Month.of.Observation) %>%
  summarize(mean_all = mean(cnt_all))

#Anomalies dataframe
monthly_anom <- pinnipeds_ocean %>%
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Pinniped.Common.Name != 'NA' | !is.na(Pinniped.Common.Name)) %>%
  group_by(Year.of.Observation, Month.of.Observation, Pinniped.Common.Name) %>%
  summarize(cnt_all = n_distinct(National.Database.Number)) %>%
  merge(monthly_mean_all, by = c('Pinniped.Common.Name', 'Month.of.Observation'), all = T) %>%
  transform(strand_anom_all = cnt_all - mean_all) %>%
  merge(monthly_anom_HI, by = c('Pinniped.Common.Name', 'Month.of.Observation', 'Year.of.Observation'), all = T) %>%
  merge(monthly_anom_FI, by = c('Pinniped.Common.Name', 'Month.of.Observation', 'Year.of.Observation'), all = T) %>%
  merge(ocean, by = c('Year.of.Observation', 'Month.of.Observation'))

monthly_anom_melt <- monthly_anom %>%
  select(-matches("lag")) %>%
  select(-matches("cat")) %>%
  select(-matches("_all")) %>%
  select(-matches("mean")) %>%
  select(-matches("cnt")) %>%
  melt(id.vars = c('Date', 'Year.of.Observation', 'Month.of.Observation', 'Pinniped.Common.Name'))

#Strandings anomalies plot - separate species
strand_plot <- ggplot(monthly_anom, aes(Date, strand_anom_all, col = Pinniped.Common.Name)) +
  geom_line() +
  geom_line(aes(y = 0), col = 'grey60') +
  xlab("") + ylab("Monthly Stranding Anomalies") +
  plot_theme(legend.position = 'top')

#Strandings and ocean anomalies plot - separate species
anom_plot <- ggplot(monthly_anom_melt %>% 
                      # filter(variable == 'strand_anom_all' |
                      #        variable == 'MEI' | variable == 'NPGO' |
                      #        variable == 'PDO'), 
                      aes(Date, value, col = variable)) +
  geom_line() +
  geom_line(aes(y = 0), col = 'grey60') +
  xlab("") + ylab("Monthly Anomalies") +
  plot_theme(legend.position = 'top')

```

```{r}

#ocean indicators anomalies plot
ocean_plot_data <- ocean %>%
  filter(-matches("lag")) %>%
  melt(id.vars = 'Date')

ocean_plot <- ggplot(data = ocean_plot_data %>% 
                       filter(!grepl("SST", variable) & !grepl("welling", variable) & !grepl("Wind", variable)),
                     aes(Date, value, group = variable, col = variable)) +
  geom_line() +
  geom_line(aes(y = 0), col = 'grey60') +
  xlab("") + ylab("Monthly Oceanographic Index Anomalies") +
  plot_theme(legend.position = 'top') +
  scale_color_manual(values = color1)

```

```{r}


```



```{r}

#Do more pinnipeds strand (or HI/FI cases) during EN compared to LN conditions?

#All strandings
ENSO_all <- pinnipeds_ocean %>% 
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Water.Body != 'Inland_WA') %>%
  group_by(ENSO_cat, Month.of.Observation, Pinniped.Common.Name) %>%
  summarize(cnt = n_distinct(National.Database.Number))

ENSO_all_figure <- 
  ggplot(ENSO_all, aes(x = Pinniped.Common.Name, y = cnt, fill = ENSO_cat)) +
  geom_boxplot() +
  xlab(" ") + ylab("Monthly Stranding Cases") +
  scale_y_continuous(labels = comma) +
  plot_theme() +
  scale_fill_manual(values = color1)

#Stellers and CSLs sig at p < 0.1 when all included
#Excluding inland waters, all combined significant, and all but CSL
summary(aov(cnt ~ ENSO_cat, data = ENSO_all))
summary(aov(cnt ~ ENSO_cat, data = ENSO_all %>% filter(Pinniped.Common.Name == 'California sea lion'))) 
kruskal.test(ENSO_all)
kruskalmc(cnt ~ ENSO_cat, ENSO_all %>% filter(Pinniped.Common.Name == 'Steller sea lion'))

#All HI cases
ENSO_HI <- pinnipeds_ocean %>% 
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Findings.of.Human.Interaction == 'Y' & Interaction.Type != 'NA') %>%
  filter(Water.Body != 'Inland_WA') %>%
  group_by(ENSO_cat, Month.of.Observation, Pinniped.Common.Name) %>%
  summarize(cnt = n_distinct(National.Database.Number))

ENSO_HI_figure <- 
  ggplot(ENSO_HI, aes(x = Pinniped.Common.Name, y = cnt, fill = ENSO_cat)) +
  geom_boxplot() +
  xlab(" ") + ylab("Monthly Stranding Cases") +
  scale_y_continuous(labels = comma) +
  plot_theme() +
  #facet_grid(~Pinniped.Common.Name) +
  scale_fill_manual(values = color1)

#Seems less differences when exclude inland for HI
summary(aov(cnt ~ ENSO_cat, data = ENSO_HI))

#FI and gunshots
#Interesting that there is greater variation during EN months
ENSO_FI <- pinnipeds_ocean %>% 
  filter(Observation.Status == 'ALIVE' | Observation.Status == 'FRESH DEAD') %>%
  filter(Interaction.Type == 'Gunshot' | Interaction.Type == 'Fisheries') %>%
  filter(Water.Body != 'Inland_WA') %>%
  group_by(ENSO_cat, Month.of.Observation, Pinniped.Common.Name) %>%
  summarize(cnt = n_distinct(National.Database.Number))

ENSO_FI_gun_figure <- 
  ggplot(data = ENSO_FI, aes(x = Pinniped.Common.Name, y = cnt, fill = ENSO_cat)) +
  geom_boxplot() +
  xlab(" ") + ylab("Monthly Stranding Cases") +
  scale_y_continuous(labels = comma) +
  plot_theme() +
  #facet_grid(~Pinniped.Common.Name) +
  scale_fill_manual(values = color1)

#Gunshots sig dif by itself, and combined = sig, fisheries not sig dif alone, looks like
#driven by HS, though they were least sig different for overall strandings
#less significance when exclude inland - prob bc of Columbia River
summary(aov(cnt ~ ENSO_cat, data = ENSO_FI %>% filter(Pinniped.Common.Name == 'Harbor seal')))


```


```{r}

```


